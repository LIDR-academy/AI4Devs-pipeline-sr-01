name: CI/CD Pipeline - LTI Backend Deployment

# Trigger: Se ejecuta en push a ramas que tienen PR abierto
on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

# Variables de entorno globales
env:
  NODE_VERSION: '18'
  BACKEND_DIR: './backend'

jobs:
  # JOB 1: TESTS - Ejecutar pruebas del backend
  tests:
    name: ğŸ§ª Run Backend Tests
    runs-on: ubuntu-latest
    
    steps:
      # Checkout del cÃ³digo fuente
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Configurar Node.js
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.BACKEND_DIR }}/package-lock.json

      # Instalar dependencias del backend
      - name: ğŸ“¦ Install backend dependencies
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm ci

      # Generar cliente de Prisma
      - name: ğŸ”§ Generate Prisma client
        working-directory: ${{ env.BACKEND_DIR }}
        run: npx prisma generate

      # Ejecutar tests
      - name: ğŸ§ª Run tests
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm test

      # Subir reporte de cobertura (opcional)
      - name: ğŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: ${{ env.BACKEND_DIR }}/coverage/

  # JOB 2: BUILD - Compilar aplicaciÃ³n (solo si tests pasan)
  build:
    name: ğŸ—ï¸ Build Backend Application
    runs-on: ubuntu-latest
    needs: tests # Depende del job tests
    
    steps:
      # Checkout del cÃ³digo fuente
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Configurar Node.js
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.BACKEND_DIR }}/package-lock.json

      # Instalar dependencias del backend
      - name: ğŸ“¦ Install backend dependencies
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm ci

      # Generar cliente de Prisma
      - name: ğŸ”§ Generate Prisma client
        working-directory: ${{ env.BACKEND_DIR }}
        run: npx prisma generate

      # Compilar aplicaciÃ³n TypeScript
      - name: ğŸ—ï¸ Build backend application
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm run build

      # Verificar que el build se generÃ³ correctamente
      - name: âœ… Verify build output
        working-directory: ${{ env.BACKEND_DIR }}
        run: |
          if [ ! -f "dist/index.js" ]; then
            echo "âŒ Build failed: dist/index.js not found"
            exit 1
          fi
          echo "âœ… Build successful: dist/index.js found"

      # Guardar artefactos del build
      - name: ğŸ’¾ Save build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: |
            ${{ env.BACKEND_DIR }}/dist/
            ${{ env.BACKEND_DIR }}/package.json
            ${{ env.BACKEND_DIR }}/package-lock.json
            ${{ env.BACKEND_DIR }}/prisma/
          retention-days: 1

  # JOB 3: DEPLOY - Desplegar en EC2 (solo si build es exitoso)
  deploy:
    name: ğŸš€ Deploy to EC2
    runs-on: ubuntu-latest
    needs: build # Depende del job build
    if: github.ref == 'refs/heads/main' # Solo deploy en main branch
    
    steps:
      # Checkout del cÃ³digo fuente
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Descargar artefactos del build
      - name: ğŸ“¦ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: ${{ env.BACKEND_DIR }}/

      # Configurar clave SSH para conexiÃ³n a EC2
      - name: ğŸ”‘ Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # Crear directorio de aplicaciÃ³n en EC2
      - name: ğŸ“ Create application directory on EC2
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} '
            sudo mkdir -p /opt/lti-backend
            sudo chown $USER:$USER /opt/lti-backend
          '

      # Copiar archivos al servidor EC2
      - name: ğŸ“¤ Copy files to EC2
        run: |
          # Copiar archivos de la aplicaciÃ³n
          scp -i ~/.ssh/id_rsa -r ${{ env.BACKEND_DIR }}/dist/ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/opt/lti-backend/
          scp -i ~/.ssh/id_rsa ${{ env.BACKEND_DIR }}/package*.json ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/opt/lti-backend/
          scp -i ~/.ssh/id_rsa -r ${{ env.BACKEND_DIR }}/prisma/ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/opt/lti-backend/

      # Instalar dependencias y configurar aplicaciÃ³n en EC2
      - name: âš™ï¸ Setup application on EC2
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} '
            cd /opt/lti-backend
            
            # Instalar Node.js si no estÃ¡ instalado
            if ! command -v node &> /dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            
            # Instalar PM2 globalmente si no estÃ¡ instalado
            if ! command -v pm2 &> /dev/null; then
              sudo npm install -g pm2
            fi
            
            # Instalar solo dependencias de producciÃ³n
            npm ci --only=production
            
            # Configurar variables de entorno
            echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
            echo "PORT=3010" >> .env
            echo "NODE_ENV=production" >> .env
            
            # Generar cliente de Prisma
            npx prisma generate
          '

      # Ejecutar migraciones de base de datos
      - name: ğŸ—„ï¸ Run database migrations
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} '
            cd /opt/lti-backend
            npx prisma migrate deploy
          '

      # Reiniciar aplicaciÃ³n con PM2
      - name: ğŸ”„ Restart application with PM2
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} '
            cd /opt/lti-backend
            
            # Detener aplicaciÃ³n existente si estÃ¡ corriendo
            pm2 stop lti-backend || true
            pm2 delete lti-backend || true
            
            # Iniciar aplicaciÃ³n con PM2
            pm2 start dist/index.js --name "lti-backend" --time
            
            # Guardar configuraciÃ³n de PM2
            pm2 save
            pm2 startup
          '

      # Verificar que la aplicaciÃ³n estÃ© corriendo
      - name: ğŸ” Health check
        run: |
          sleep 30 # Esperar a que la aplicaciÃ³n inicie
          
          # Verificar que la aplicaciÃ³n responde
          if curl -f http://${{ secrets.EC2_HOST }}:3010/health > /dev/null 2>&1; then
            echo "âœ… Application is running successfully!"
          else
            echo "âŒ Health check failed"
            # Mostrar logs en caso de error
            ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'pm2 logs lti-backend --lines 50'
            exit 1
          fi

      # Limpiar archivos temporales
      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
          rm -rf ${{ env.BACKEND_DIR }}/dist/

  # NotificaciÃ³n de resultado
  notify:
    name: ğŸ“¢ Notify Deployment Result
    runs-on: ubuntu-latest
    needs: [tests, build, deploy]
    if: always()
    
    steps:
      - name: ğŸ“¢ Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "ğŸ‰ Deployment completed successfully!"
            echo "ğŸŒ Application is running at: http://${{ secrets.EC2_HOST }}:3010"
          elif [ "${{ needs.tests.result }}" == "failure" ]; then
            echo "âŒ Tests failed - Deployment aborted"
          elif [ "${{ needs.build.result }}" == "failure" ]; then
            echo "âŒ Build failed - Deployment aborted"
          else
            echo "âŒ Deployment failed"
          fi
